services:
  bibbl-stream:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: "${BIBBL_VERSION:-0.2.1}"
        COMMIT: "${BIBBL_COMMIT:-docker}"
        DATE: "${BIBBL_BUILD_DATE:-2025-11-15T00:00:00Z}"
    image: bibbl-stream:${BIBBL_VERSION:-latest}
    container_name: bibbl-stream
    restart: unless-stopped
    
    # Network configuration for assigned IP
    networks:
      bibbl_net:
        ipv4_address: 192.168.0.218
    
    ports:
      - "8443:443"    # Web UI/API over HTTPS (dev port)
      - "6515:6514"   # Syslog TLS (dev port)
    
    environment:
      # Server configuration
      BIBBL_SERVER_HOST: "0.0.0.0"
      BIBBL_SERVER_PORT: "443"
      BIBBL_SERVER_TLS_CERT_FILE: "/certs/server.crt"
      BIBBL_SERVER_TLS_KEY_FILE: "/certs/server.key"
      
      # TLS configuration - will use auto-generated certs for bibbl.clarityxdr.com
      BIBBL_SERVER_TLS_MIN_VERSION: "1.2"
      BIBBL_TLS_EXTRA_HOSTS: "bibbl.clarityxdr.com,192.168.0.218"
      
      # Logging
      BIBBL_LOGGING_LEVEL: "info"
      BIBBL_LOGGING_FORMAT: "json"
      
      # Syslog input
      BIBBL_INPUTS_SYSLOG_ENABLED: "true"
      BIBBL_INPUTS_SYSLOG_HOST: "0.0.0.0"
      BIBBL_INPUTS_SYSLOG_PORT: "6514"
      BIBBL_INPUTS_SYSLOG_TLS_MIN_VERSION: "1.2"
    
    volumes:
      # Persistent data
      - bibbl-data:/app/data
      - bibbl-logs:/app/logs
      # Built-in TLS certs are already present in the image (/certs)
      # Configuration (optional - will use defaults if not provided)
      - ./config:/app/config:ro
    
    healthcheck:
      test: ["CMD", "/bibbl-stream", "-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bibbl.rule=Host(`bibbl.clarityxdr.com`)"
      - "traefik.http.routers.bibbl.tls=true"
      - "traefik.http.services.bibbl.loadbalancer.server.port=443"
      - "traefik.http.services.bibbl.loadbalancer.server.scheme=https"

networks:
  bibbl_net:
    external: true

volumes:
  bibbl-data:
    driver: local
  bibbl-logs:
    driver: local
