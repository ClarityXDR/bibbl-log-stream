services:
  bibbl-stream:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: "${BIBBL_VERSION:-0.1.0}"
        COMMIT: "${BIBBL_COMMIT:-docker}"
        DATE: "${BIBBL_BUILD_DATE}"
    image: bibbl-stream:${BIBBL_VERSION:-latest}
    container_name: bibbl-stream
    restart: unless-stopped
    
    # Network configuration for assigned IP
    networks:
      clarity-lan:
        ipv4_address: 192.168.0.218
    
    ports:
      - "9444:9444"   # Web UI/API
      - "6514:6514"   # Syslog TLS
    
    environment:
      # Server configuration
      BIBBL_SERVER_HOST: "0.0.0.0"
      BIBBL_SERVER_PORT: "9444"
      
      # TLS configuration - will use auto-generated certs for bibbl.clarityxdr.com
      BIBBL_SERVER_TLS_MIN_VERSION: "1.2"
      BIBBL_TLS_EXTRA_HOSTS: "bibbl.clarityxdr.com,192.168.0.218"
      
      # Logging
      BIBBL_LOGGING_LEVEL: "info"
      BIBBL_LOGGING_FORMAT: "json"
      
      # Syslog input
      BIBBL_INPUTS_SYSLOG_ENABLED: "true"
      BIBBL_INPUTS_SYSLOG_HOST: "0.0.0.0"
      BIBBL_INPUTS_SYSLOG_PORT: "6514"
      BIBBL_INPUTS_SYSLOG_TLS_MIN_VERSION: "1.2"
    
    volumes:
      # Persistent data
      - bibbl-data:/app/data
      - bibbl-logs:/app/logs
      
      # TLS certificates (optional - will auto-generate if not provided)
      - ./certs:/app/certs:ro
      
      # Configuration (optional - will use defaults if not provided)
      - ./config:/app/config:ro
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9444/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bibbl.rule=Host(`bibbl.clarityxdr.com`)"
      - "traefik.http.routers.bibbl.tls=true"
      - "traefik.http.services.bibbl.loadbalancer.server.port=9444"

networks:
  clarity-lan:
    driver: macvlan
    ipam:
      config:
        - subnet: 192.168.0.0/24
          gateway: 192.168.0.1

volumes:
  bibbl-data:
    driver: local
  bibbl-logs:
    driver: local
